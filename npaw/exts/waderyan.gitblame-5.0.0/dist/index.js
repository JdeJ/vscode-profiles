"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e,r=require("vscode"),n=require("child_process"),o=require("url"),i=require("path"),s=require("fs"),a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};!function(t){!function(e){var r="object"==typeof a?a:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),n=o(t);function o(t,e){return function(r,n){"function"!=typeof t[r]&&Object.defineProperty(t,r,{configurable:!0,writable:!0,value:n}),e&&e(r,n)}}void 0===r.Reflect?r.Reflect=t:n=o(r.Reflect,n),function(t){var e=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,n=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",o=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",i="function"==typeof Object.create,s={__proto__:[]}instanceof Array,a=!i&&!s,c={create:i?function(){return nt(Object.create(null))}:s?function(){return nt({__proto__:null})}:function(){return nt({})},has:a?function(t,r){return e.call(t,r)}:function(t,e){return e in t},get:a?function(t,r){return e.call(t,r)?t[r]:void 0}:function(t,e){return t[e]}},u=Object.getPrototypeOf(Function),l="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,f=l||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?tt():Map,h=l||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?et():Set,p=new(l||"function"!=typeof WeakMap?rt():WeakMap);function m(t,e,r,n){if(U(r)){if(!z(t))throw new TypeError;if(!G(e))throw new TypeError;return C(t,e)}if(!z(t))throw new TypeError;if(!L(e))throw new TypeError;if(!L(n)&&!U(n)&&!$(n))throw new TypeError;return $(n)&&(n=void 0),S(t,e,r=H(r),n)}function d(t,e){function r(r,n){if(!L(r))throw new TypeError;if(!U(n)&&!K(n))throw new TypeError;O(t,e,r,n)}return r}function y(t,e,r,n){if(!L(r))throw new TypeError;return U(n)||(n=H(n)),O(t,e,r,n)}function g(t,e,r){if(!L(e))throw new TypeError;return U(r)||(r=H(r)),k(t,e,r)}function v(t,e,r){if(!L(e))throw new TypeError;return U(r)||(r=H(r)),I(t,e,r)}function w(t,e,r){if(!L(e))throw new TypeError;return U(r)||(r=H(r)),M(t,e,r)}function b(t,e,r){if(!L(e))throw new TypeError;return U(r)||(r=H(r)),P(t,e,r)}function _(t,e){if(!L(t))throw new TypeError;return U(e)||(e=H(e)),A(t,e)}function T(t,e){if(!L(t))throw new TypeError;return U(e)||(e=H(e)),R(t,e)}function E(t,e,r){if(!L(e))throw new TypeError;U(r)||(r=H(r));var n=x(e,r,!1);if(U(n))return!1;if(!n.delete(t))return!1;if(n.size>0)return!0;var o=p.get(e);return o.delete(r),o.size>0||p.delete(e),!0}function C(t,e){for(var r=t.length-1;r>=0;--r){var n=(0,t[r])(e);if(!U(n)&&!$(n)){if(!G(n))throw new TypeError;e=n}}return e}function S(t,e,r,n){for(var o=t.length-1;o>=0;--o){var i=(0,t[o])(e,r,n);if(!U(i)&&!$(i)){if(!L(i))throw new TypeError;n=i}}return n}function x(t,e,r){var n=p.get(t);if(U(n)){if(!r)return;n=new f,p.set(t,n)}var o=n.get(e);if(U(o)){if(!r)return;o=new f,n.set(e,o)}return o}function k(t,e,r){if(I(t,e,r))return!0;var n=X(e);return!$(n)&&k(t,n,r)}function I(t,e,r){var n=x(e,r,!1);return!U(n)&&N(n.has(t))}function M(t,e,r){if(I(t,e,r))return P(t,e,r);var n=X(e);return $(n)?void 0:M(t,n,r)}function P(t,e,r){var n=x(e,r,!1);if(!U(n))return n.get(t)}function O(t,e,r,n){x(r,n,!0).set(t,e)}function A(t,e){var r=R(t,e),n=X(t);if(null===n)return r;var o=A(n,e);if(o.length<=0)return r;if(r.length<=0)return o;for(var i=new h,s=[],a=0,c=r;a<c.length;a++){var u=c[a];i.has(u)||(i.add(u),s.push(u))}for(var l=0,f=o;l<f.length;l++){u=f[l];i.has(u)||(i.add(u),s.push(u))}return s}function R(t,e){var r=[],n=x(t,e,!1);if(U(n))return r;for(var o=Y(n.keys()),i=0;;){var s=J(o);if(!s)return r.length=i,r;var a=Z(s);try{r[i]=a}catch(t){try{Q(o)}finally{throw t}}i++}}function j(t){if(null===t)return 1;switch(typeof t){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===t?1:6;default:return 6}}function U(t){return void 0===t}function $(t){return null===t}function F(t){return"symbol"==typeof t}function L(t){return"object"==typeof t?null!==t:"function"==typeof t}function D(t,e){switch(j(t)){case 0:case 1:case 2:case 3:case 4:case 5:return t}var r=3===e?"string":5===e?"number":"default",o=q(t,n);if(void 0!==o){var i=o.call(t,r);if(L(i))throw new TypeError;return i}return B(t,"default"===r?"number":r)}function B(t,e){if("string"===e){var r=t.toString;if(V(r))if(!L(o=r.call(t)))return o;if(V(n=t.valueOf))if(!L(o=n.call(t)))return o}else{var n;if(V(n=t.valueOf))if(!L(o=n.call(t)))return o;var o,i=t.toString;if(V(i))if(!L(o=i.call(t)))return o}throw new TypeError}function N(t){return!!t}function W(t){return""+t}function H(t){var e=D(t,3);return F(e)?e:W(e)}function z(t){return Array.isArray?Array.isArray(t):t instanceof Object?t instanceof Array:"[object Array]"===Object.prototype.toString.call(t)}function V(t){return"function"==typeof t}function G(t){return"function"==typeof t}function K(t){switch(j(t)){case 3:case 4:return!0;default:return!1}}function q(t,e){var r=t[e];if(null!=r){if(!V(r))throw new TypeError;return r}}function Y(t){var e=q(t,o);if(!V(e))throw new TypeError;var r=e.call(t);if(!L(r))throw new TypeError;return r}function Z(t){return t.value}function J(t){var e=t.next();return!e.done&&e}function Q(t){var e=t.return;e&&e.call(t)}function X(t){var e=Object.getPrototypeOf(t);if("function"!=typeof t||t===u)return e;if(e!==u)return e;var r=t.prototype,n=r&&Object.getPrototypeOf(r);if(null==n||n===Object.prototype)return e;var o=n.constructor;return"function"!=typeof o||o===t?e:o}function tt(){var t={},e=[],r=function(){function t(t,e,r){this._index=0,this._keys=t,this._values=e,this._selector=r}return t.prototype["@@iterator"]=function(){return this},t.prototype[o]=function(){return this},t.prototype.next=function(){var t=this._index;if(t>=0&&t<this._keys.length){var r=this._selector(this._keys[t],this._values[t]);return t+1>=this._keys.length?(this._index=-1,this._keys=e,this._values=e):this._index++,{value:r,done:!1}}return{value:void 0,done:!0}},t.prototype.throw=function(t){throw this._index>=0&&(this._index=-1,this._keys=e,this._values=e),t},t.prototype.return=function(t){return this._index>=0&&(this._index=-1,this._keys=e,this._values=e),{value:t,done:!0}},t}();return function(){function e(){this._keys=[],this._values=[],this._cacheKey=t,this._cacheIndex=-2}return Object.defineProperty(e.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),e.prototype.has=function(t){return this._find(t,!1)>=0},e.prototype.get=function(t){var e=this._find(t,!1);return e>=0?this._values[e]:void 0},e.prototype.set=function(t,e){var r=this._find(t,!0);return this._values[r]=e,this},e.prototype.delete=function(e){var r=this._find(e,!1);if(r>=0){for(var n=this._keys.length,o=r+1;o<n;o++)this._keys[o-1]=this._keys[o],this._values[o-1]=this._values[o];return this._keys.length--,this._values.length--,e===this._cacheKey&&(this._cacheKey=t,this._cacheIndex=-2),!0}return!1},e.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=t,this._cacheIndex=-2},e.prototype.keys=function(){return new r(this._keys,this._values,n)},e.prototype.values=function(){return new r(this._keys,this._values,i)},e.prototype.entries=function(){return new r(this._keys,this._values,s)},e.prototype["@@iterator"]=function(){return this.entries()},e.prototype[o]=function(){return this.entries()},e.prototype._find=function(t,e){return this._cacheKey!==t&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=t)),this._cacheIndex<0&&e&&(this._cacheIndex=this._keys.length,this._keys.push(t),this._values.push(void 0)),this._cacheIndex},e}();function n(t,e){return t}function i(t,e){return e}function s(t,e){return[t,e]}}function et(){return function(){function t(){this._map=new f}return Object.defineProperty(t.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this._map.has(t)},t.prototype.add=function(t){return this._map.set(t,t),this},t.prototype.delete=function(t){return this._map.delete(t)},t.prototype.clear=function(){this._map.clear()},t.prototype.keys=function(){return this._map.keys()},t.prototype.values=function(){return this._map.values()},t.prototype.entries=function(){return this._map.entries()},t.prototype["@@iterator"]=function(){return this.keys()},t.prototype[o]=function(){return this.keys()},t}()}function rt(){var t=16,r=c.create(),n=o();return function(){function t(){this._key=o()}return t.prototype.has=function(t){var e=i(t,!1);return void 0!==e&&c.has(e,this._key)},t.prototype.get=function(t){var e=i(t,!1);return void 0!==e?c.get(e,this._key):void 0},t.prototype.set=function(t,e){return i(t,!0)[this._key]=e,this},t.prototype.delete=function(t){var e=i(t,!1);return void 0!==e&&delete e[this._key]},t.prototype.clear=function(){this._key=o()},t}();function o(){var t;do{t="@@WeakMap@@"+u()}while(c.has(r,t));return r[t]=!0,t}function i(t,r){if(!e.call(t,n)){if(!r)return;Object.defineProperty(t,n,{value:c.create()})}return t[n]}function s(t,e){for(var r=0;r<e;++r)t[r]=255*Math.random()|0;return t}function a(t){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(t)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(t)):s(new Uint8Array(t),t):s(new Array(t),t)}function u(){var e=a(t);e[6]=79&e[6]|64,e[8]=191&e[8]|128;for(var r="",n=0;n<t;++n){var o=e[n];4!==n&&6!==n&&8!==n||(r+="-"),o<16&&(r+="0"),r+=o.toString(16).toLowerCase()}return r}}function nt(t){return t.__=void 0,delete t.__,t}t("decorate",m),t("metadata",d),t("defineMetadata",y),t("hasMetadata",g),t("hasOwnMetadata",v),t("getMetadata",w),t("getOwnMetadata",b),t("getMetadataKeys",_),t("getOwnMetadataKeys",T),t("deleteMetadata",E)}(n)}()}(t||(t={})),function(t){t[t.Transient=0]="Transient",t[t.Singleton=1]="Singleton",t[t.ResolutionScoped=2]="ResolutionScoped",t[t.ContainerScoped=3]="ContainerScoped"}(e||(e={}));var c=e;
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function u(t,e,r,n){var o,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(s=(i<3?o(s):i>3?o(e,r,s):o(e,r))||s);return i>3&&s&&Object.defineProperty(e,r,s),s}function l(t,e){return function(r,n){e(r,n,t)}}function f(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function h(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function p(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s}function m(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(p(arguments[e]));return t}function d(t){return!!t.useClass}function y(t){return!!t.useFactory}var g=function(){function t(t){this.wrap=t,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct"]}return t.prototype.createProxy=function(t){var e,r=this,n=!1;return new Proxy({},this.createHandler((function(){return n||(e=t(r.wrap()),n=!0),e})))},t.prototype.createHandler=function(t){var e={};return this.reflectMethods.forEach((function(r){e[r]=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];e[0]=t();var o=Reflect[r];return o.apply(void 0,m(e))}})),e},t}();function v(t){return"string"==typeof t||"symbol"==typeof t}function w(t){return!!t.useToken}function b(t){return null!=t.useValue}var _=function(){function t(){this._registryMap=new Map}return t.prototype.entries=function(){return this._registryMap.entries()},t.prototype.getAll=function(t){return this.ensure(t),this._registryMap.get(t)},t.prototype.get=function(t){this.ensure(t);var e=this._registryMap.get(t);return e[e.length-1]||null},t.prototype.set=function(t,e){this.ensure(t),this._registryMap.get(t).push(e)},t.prototype.setAll=function(t,e){this._registryMap.set(t,e)},t.prototype.has=function(t){return this.ensure(t),this._registryMap.get(t).length>0},t.prototype.clear=function(){this._registryMap.clear()},t.prototype.ensure=function(t){this._registryMap.has(t)||this._registryMap.set(t,[])},t}(),T=function(){this.scopedResolutions=new Map};function E(t,e,r){var n,o,i=p(t.toString().match(/constructor\(([\w, ]+)\)/)||[],2)[1],s=function(t,e){return null===t?"at position #"+e:'"'+t.split(",")[e].trim()+'" at position #'+e}(void 0===i?null:i,e);return n="Cannot inject the dependency "+s+' of "'+t.name+'" constructor. Reason:',void 0===o&&(o="    "),m([n],r.message.split("\n").map((function(t){return o+t}))).join("\n")}var C=new Map,S=new(function(){function t(t){this.parent=t,this._registry=new _}return t.prototype.register=function(t,e,r){var n;if(void 0===r&&(r={lifecycle:c.Transient}),n=function(t){return d(t)||b(t)||w(t)||y(t)}(e)?e:{useClass:e},(r.lifecycle===c.Singleton||r.lifecycle==c.ContainerScoped||r.lifecycle==c.ResolutionScoped)&&(b(n)||y(n)))throw new Error('Cannot use lifecycle "'+c[r.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(t,{provider:n,options:r}),this},t.prototype.registerType=function(t,e){return v(e)?this.register(t,{useToken:e}):this.register(t,{useClass:e})},t.prototype.registerInstance=function(t,e){return this.register(t,{useValue:e})},t.prototype.registerSingleton=function(t,e){if(v(t)){if(v(e))return this.register(t,{useToken:e},{lifecycle:c.Singleton});if(e)return this.register(t,{useClass:e},{lifecycle:c.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var r=t;return e&&!v(e)&&(r=e),this.register(t,{useClass:r},{lifecycle:c.Singleton})},t.prototype.resolve=function(t,e){void 0===e&&(e=new T);var r=this.getRegistration(t);if(!r&&v(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');if(r)return this.resolveRegistration(r,e);if(function(t){return"function"==typeof t||t instanceof g}(t))return this.construct(t,e);throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},t.prototype.resolveRegistration=function(t,e){if(t.options.lifecycle===c.ResolutionScoped&&e.scopedResolutions.has(t))return e.scopedResolutions.get(t);var r,n=t.options.lifecycle===c.Singleton,o=t.options.lifecycle===c.ContainerScoped,i=n||o;return r=b(t.provider)?t.provider.useValue:w(t.provider)?i?t.instance||(t.instance=this.resolve(t.provider.useToken,e)):this.resolve(t.provider.useToken,e):d(t.provider)?i?t.instance||(t.instance=this.construct(t.provider.useClass,e)):this.construct(t.provider.useClass,e):y(t.provider)?t.provider.useFactory(this):this.construct(t.provider,e),t.options.lifecycle===c.ResolutionScoped&&e.scopedResolutions.set(t,r),r},t.prototype.resolveAll=function(t,e){var r=this;void 0===e&&(e=new T);var n=this.getAllRegistrations(t);if(!n&&v(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');return n?n.map((function(t){return r.resolveRegistration(t,e)})):[this.construct(t,e)]},t.prototype.isRegistered=function(t,e){return void 0===e&&(e=!1),this._registry.has(t)||e&&(this.parent||!1)&&this.parent.isRegistered(t,!0)},t.prototype.reset=function(){this._registry.clear()},t.prototype.clearInstances=function(){var t,e;try{for(var r=h(this._registry.entries()),n=r.next();!n.done;n=r.next()){var o=p(n.value,2),i=o[0],s=o[1];this._registry.setAll(i,s.filter((function(t){return!b(t.provider)})).map((function(t){return t.instance=void 0,t})))}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},t.prototype.createChildContainer=function(){var e,r,n=new t(this);try{for(var o=h(this._registry.entries()),i=o.next();!i.done;i=o.next()){var s=p(i.value,2),a=s[0],u=s[1];u.some((function(t){return t.options.lifecycle===c.ContainerScoped}))&&n._registry.setAll(a,u.map((function(t){return t.options.lifecycle===c.ContainerScoped?{provider:t.provider,options:t.options}:t})))}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}return n},t.prototype.getRegistration=function(t){return this.isRegistered(t)?this._registry.get(t):this.parent?this.parent.getRegistration(t):null},t.prototype.getAllRegistrations=function(t){return this.isRegistered(t)?this._registry.getAll(t):this.parent?this.parent.getAllRegistrations(t):null},t.prototype.construct=function(t,e){var r=this;if(t instanceof g)return t.createProxy((function(t){return r.resolve(t,e)}));if(0===t.length)return new t;var n=C.get(t);if(!n||0===n.length)throw new Error('TypeInfo not known for "'+t.name+'"');var o=n.map(this.resolveParams(e,t));return new(t.bind.apply(t,m([void 0],o)))},t.prototype.resolveParams=function(t,e){var r=this;return function(n,o){try{return"object"==typeof(i=n)&&"token"in i&&"multiple"in i?n.multiple?r.resolveAll(n.token):r.resolve(n.token,t):r.resolve(n,t)}catch(t){throw new Error(E(e,o,t))}var i}},t}());function x(t){return e=t,function(t,r,n){var o=Reflect.getOwnMetadata("injectionTokens",t)||{};o[n]=e,Reflect.defineMetadata("injectionTokens",o,t)};var e}function k(){return function(t){C.set(t,function(t){var e=Reflect.getMetadata("design:paramtypes",t)||[],r=Reflect.getOwnMetadata("injectionTokens",t)||{};return Object.keys(r).forEach((function(t){e[+t]=r[t]})),e}(t))}}if("undefined"==typeof Reflect||!Reflect.getMetadata)throw new Error("tsyringe requires a reflect polyfill. Please add 'import \"reflect-metadata\"' to the top of your entry point.");class I{get(){return r.window.activeTextEditor}}class M{write(t){return r.env.clipboard.writeText(t)}}class P{execute(t,...e){return r.commands.executeCommand(t,...e)}}class O{changeActiveEditor(t,e,n){return r.window.onDidChangeActiveTextEditor(t,e,n)}changeSelection(t,e,n){return r.window.onDidChangeTextEditorSelection(t,e,n)}saveDocument(t,e,n){return r.workspace.onDidSaveTextDocument(t,e,n)}closeDocument(t,e,n){return r.workspace.onDidCloseTextDocument(t,e,n)}}class A{get(){return r.extensions.getExtension("vscode.git")}}class R{in(t){return void 0!==r.workspace.getWorkspaceFolder(t)}has(){return!!r.workspace.workspaceFolders}properties(){return r.workspace.getConfiguration("gitblame")}}class j{constructor(){this.title="NO_TITLE",this.action=()=>{}}setTitle(t){this.title=t}setAction(t){this.action=t}takeAction(){this.action()}}var U;!function(t){t.Info="info",t.Error="error",t.Command="command",t.Critical="critical"}(U||(U={}));let $=class{constructor(t){this.outputChannel=t.create("Extension: gitblame")}logInfo(t){this.writeToLog(U.Info,t)}logCommand(t){this.writeToLog(U.Command,t)}logError(t){this.writeToLog(U.Error,t.toString())}logCritical(t,e){this.writeToLog(U.Critical,t.toString()),this.showErrorMessage(e)}dispose(){this.outputChannel.dispose()}timestamp(){const t=new Date;return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}async showErrorMessage(t){"Show Log"===await S.resolve("MessageService").showError(t,"Show Log")&&this.outputChannel.show()}writeToLog(t,e){if(S.resolve("Property").get("logNonCritical")||t===U.Critical){const r=e.trim(),n=this.timestamp();this.outputChannel.appendLine(`[ ${n} | ${t} ] ${r}`)}}};$=u([function(t){k()(t),S.registerSingleton(t)},l(0,x("OutputChannelFactory")),f("design:paramtypes",[Object])],$);class F{async execute(t,e,r={}){let o;S.resolve("ErrorHandler").logCommand(`${t} ${e.join(" ")}`);try{if(o=n.execFile(t,e,{...r,encoding:"utf8"}),null===o.stdout)return""}catch(t){return S.resolve("ErrorHandler").logError(t),""}let i="";for await(const t of o.stdout)i+=t;return i.trim()}}let L=class{get(t){return S.resolve("Workspace").properties().get(t)}};L=u([k()],L);class D{showInfo(t,...e){return r.window.showInformationMessage(t,...e)}showError(t,...e){return r.window.showErrorMessage(t,...e)}}class B{create(t){return r.window.createOutputChannel(t)}}class N{createStatusBarItem(t,e){return r.window.createStatusBarItem(t,e)}}function W(t,e,r){return 1===t?`${t} ${e}`:`${t} ${r}`}function H(t,e,r){const n=e.valueOf()-r.valueOf();return Math.round(n/t)}function z(t=!1){return{author:{mail:"",name:"",timestamp:0,tz:""},committer:{mail:"",name:"",timestamp:0,tz:""},filename:"",generated:!t,hash:"0000000000000000000000000000000000000000",summary:""}}function V(t){return"0000000000000000000000000000000000000000"===t.hash}var G;!function(t){t[t.OUT=0]="OUT",t[t.IN=1]="IN"}(G||(G={}));class K{static toTextView(t){if(V(t))return S.resolve("Property").get("statusBarMessageNoCommit")||"Not Committed Yet";const e=K.normalizeCommitInfoTokens(t),r=S.resolve("Property").get("statusBarMessageFormat");return r?K.parseTokens(r,e):"No configured message format for gitblame"}static toDateText(t,e){const r=H(315576e5,t,e);const n=function(t,e){return H(26298e5,t,e)}(t,e),o=function(t,e){return H(864e5,t,e)}(t,e),i=function(t,e){return H(36e5,t,e)}(t,e),s=function(t,e){return H(6e4,t,e)}(t,e);return s<5?"right now":s<60?s+" minutes ago":i<24?W(i,"hour","hours")+" ago":o<31?W(o,"day","days")+" ago":n<12?W(n,"month","months")+" ago":W(r,"year","years")+" ago"}static tokenParser(t){const e=t.indexOf(","),r=t.indexOf("|");return-1!==e&&-1!==r?{function:t.substring(0,e),parameter:t.substring(e+1,r),modifier:t.substring(r+1)}:-1!==e?{function:t.substring(0,e),parameter:t.substring(e+1),modifier:""}:-1!==r?{function:t.substring(0,r),parameter:"",modifier:t.substring(r+1)}:{function:t,parameter:"",modifier:""}}static parse(t){const e=[];let r=0,n=G.OUT;for(let o=0;o<t.length;o++){const i=t[o],s=t[o+2];if(n===G.OUT&&"$"===i&&"{"===t[o+1]&&/^[a-zA-Z]$/.test(s))n=G.IN,e.push(t.substring(r,o)),r=o,o+=1;else if(n===G.IN&&"}"===i){n=G.OUT;const i=o+1;e.push(K.tokenParser(t.substring(r+2,i-1))),r=i}}return e.push(t.substring(r)),e}static parseTokens(t,e){if("string"!=typeof t)return"";return K.parse(t).map(t=>{if("string"==typeof t)return t;const r=K.runKey(e,t.function,t.parameter);return K.modify(r,t.modifier)}).join("")}static runKey(t,e,r){const n=t[e];return n?n(r):e}static modify(t,e){return"u"===e?t.toUpperCase():"l"===e?t.toLowerCase():e.length?`${t}|${e}`:""+t}static normalizeCommitInfoTokens(t){const e=new Date,r=new Date(1e3*t.author.timestamp),n=new Date(1e3*t.committer.timestamp),o=t=>()=>t.toString(),i=o(K.toDateText(e,r)),s=o(K.toDateText(e,n)),a=o(r.toISOString().slice(0,10)),c=o(n.toISOString().slice(0,10)),u=(t,e)=>r=>{const n=(r||e).toString();return t.substr(0,parseInt(n,10))};return{"author.mail":o(t.author.mail),"author.name":o(t.author.name),"author.timestamp":o(t.author.timestamp),"author.tz":o(t.author.tz),"author.date":a,"commit.hash":o(t.hash),"commit.hash_short":u(t.hash,"7"),"commit.summary":u(t.summary,"65536"),"committer.mail":o(t.committer.mail),"committer.name":o(t.committer.name),"committer.timestamp":o(t.committer.timestamp),"committer.tz":o(t.committer.tz),"committer.date":c,"time.ago":i,"time.c_ago":s,"time.from":i,"time.c_from":s}}}let q=class{constructor(t){this.statusBarItem=t.createStatusBarItem(r.StatusBarAlignment.Left,S.resolve("Property").get("statusBarPositionPriority"))}clear(){this.setText("")}update(t){if(t.generated)this.clear();else{const e=!V(t);this.setText(K.toTextView(t),e)}}startProgress(){this.setText("$(sync~spin) Waiting for git blame response")}dispose(){this.statusBarItem.dispose()}setText(t,e=!1){this.statusBarItem.text=("$(git-commit) "+t).trimEnd(),e?(this.statusBarItem.tooltip="git blame",this.statusBarItem.command="gitblame.quickInfo"):(this.statusBarItem.tooltip="git blame - No info about the current line",this.statusBarItem.command=void 0),this.statusBarItem.show()}};q=u([k(),l(0,x("StatusBarItemFactory")),f("design:paramtypes",[Object])],q);class Y{constructor(){this.files=new Map}async blameLine(t,e){const r=e+1,n=await this.getBlameInfo(t),o=n.lines[r];return void 0===o?z():n.commits[o]}async removeDocument(t){const e=await this.files.get(t);void 0!==e&&(this.files.delete(t),e.dispose())}dispose(){this.files.forEach((t,e)=>{this.removeDocument(e)})}createRemovalFunction(t){return()=>{this.removeDocument(t)}}async getBlameInfo(t){const e=await this.ensureGitFile(t);return e.registerDisposeFunction(this.createRemovalFunction(t)),e.blame()}ensureGitFile(t){const e=this.files.get(t);if(e)return e;const r=S.resolve("GitFileFactory").create(t);return this.files.set(t,r),r}}const Z=new Set;function J(t){const e=t&&t.document;return!!e&&!e.isUntitled}async function Q(){const t=S.resolve("ExtensionGetter").get();if(t&&t.exports.enabled){const e=t.exports.getAPI(1);return"initialized"===e.state?Promise.resolve(e.git.path):new Promise(t=>{e.onDidChangeState(r=>{"initialized"===r&&t(e.git.path)})})}return Promise.resolve("git")}function X(t,e,r){return S.resolve("Executor").execute(t,e,{cwd:r})}function tt(t){return t.replace(/^[a-z-]+:\/\//i,"").replace(/:([a-z_.~+%-][a-z0-9_.~+%-]+)\/?/i,"/$1/").replace(/\.git$/i,"")}let et=class{constructor(t,e){this.blame=t,this.statusBarView=e,this.disposable=this.setupListeners(),this.init()}async blameLink(){const t=await this.getCommitInfo(),e=await this.getToolUrl(t);e?await S.resolve("Command").execute("vscode.open",e):S.resolve("MessageService").showError("Missing gitblame.commitUrl configuration value.")}async showMessage(){const t=await this.getCommitInfo();if(V(t))return void this.clearView();const e=S.resolve("Property").get("infoMessageFormat")||"",r=K.normalizeCommitInfoTokens(t),n=K.parseTokens(e,r),o=this.generateMessageActions(t);this.updateView(t);const i=await S.resolve("MessageService").showInfo(n,...await o);i&&i.takeAction()}async copyHash(){const t=await this.getCommitInfo();if(!t.generated)try{await S.resolve("Clipboard").write(t.hash),S.resolve("MessageService").showInfo("Copied hash to clipboard")}catch(e){S.resolve("ErrorHandler").logCritical(e,"Unable to copy hash to clipboard. hash: "+t.hash)}}async copyToolUrl(){const t=await this.getCommitInfo(),e=await this.getToolUrl(t);if(e)try{await S.resolve("Clipboard").write(e.toString()),S.resolve("MessageService").showInfo("Copied tool URL to clipboard")}catch(t){S.resolve("ErrorHandler").logCritical(t,"Unable to copy tool URL to clipboard. URL: "+e.toString())}else S.resolve("MessageService").showError("Missing gitblame.commitUrl configuration value.")}defaultWebPath(t,e,r){const n=function(t){return t.startsWith("https://")?"https":t.startsWith("http://")?"http":void 0}(t),i=tt(t);let s;try{s=new o.URL(`${null!=n?n:"https"}://${i}`)}catch(t){return!1}const a=r?"commits":"commit",c=n&&s.port?":"+s.port:"";return s.protocol+"//"+`${s.hostname}${c}`+`${s.pathname}/${a}/${e}`}projectNameFromOrigin(t){const e=/([a-zA-Z0-9_~%+.-]*?(\.git)?)$/.exec(t);return e?e[1].replace(".git",""):""}dispose(){this.disposable.dispose()}setupListeners(){const t=S.resolve("EditorEvents"),e=[];return e.push(t.changeActiveEditor(()=>{this.onTextEditorMove()}),t.changeSelection(()=>{this.onTextEditorMove()}),t.saveDocument(()=>{this.onTextEditorMove()}),t.closeDocument(t=>{this.onCloseTextDocument(t)})),r.Disposable.from(...e)}init(){this.onTextEditorMove()}async onTextEditorMove(){const t=this.getCurrentActiveFilePosition(),e=await this.getCurrentLineInfo(),r=this.getCurrentActiveFilePosition();t!==r&&"no-file:-1"!==r||this.updateView(e)}getCurrentActiveFilePosition(){const t=S.resolve("ActiveTextEditor").get();if(void 0===t)return"no-file:-1";const{document:e,selection:r}=t;return`${e.fileName}:${r.active.line}`}onCloseTextDocument(t){this.blame.removeDocument(t)}async generateMessageActions(t){const e=await this.getToolUrl(t),r=[];if(e&&e.toString()){const t=S.resolve("ActionableMessageItem");t.setTitle("View"),t.setAction(()=>{S.resolve("Command").execute("vscode.open",e)}),r.push(t)}return r}async getCommitInfo(){const t=await this.getCurrentLineInfo();return t.generated&&S.resolve("MessageService").showError("The current file and line can not be blamed."),t}async getToolUrl(t){if(V(t))return;const e=S.resolve("Property"),n=e.get("inferCommitUrl"),s=e.get("commitUrl")||"",a=e.get("remoteName")||"origin",c=await async function(t){const e=S.resolve("ActiveTextEditor").get();if(!J(e))return"";try{const r=await Q(),n=i.dirname(e.document.fileName),o=await X(r,["symbolic-ref","-q","--short","HEAD"],n),s=await X(r,["config","--local","--get",`branch.${o.trim()}.remote`],n);return(await X(r,["config","--local","--get",`remote.${s.trim()||t}.url`],n)).trim()}catch(t){return S.resolve("ErrorHandler").logError(t),""}}(a),u=await async function(t){const e=S.resolve("ActiveTextEditor").get();if(!J(e))return"";try{const r=await Q(),n=e.document.fileName,o=i.dirname(n);return(await X(r,["ls-remote","--get-url",t],o)).trim()}catch(t){return S.resolve("ErrorHandler").logError(t),""}}(a),l=await async function(){const t=S.resolve("ActiveTextEditor").get();if(!J(t))return"";try{const e=await Q(),r=t.document.fileName,n=i.dirname(r),o=i.basename(r);return(await X(e,["ls-files","--full-name",o],n)).trim()}catch(t){return S.resolve("ErrorHandler").logError(t),""}}(),f=this.projectNameFromOrigin(u),h=tt(c),p=K.parseTokens(s,{hash:()=>t.hash,"project.name":()=>f,"project.remote":()=>h,"gitorigin.hostname":this.gitOriginHostname(u),"file.path":()=>l});return function(t){let e;try{e=new o.URL(t)}catch(t){return!1}return e.href===t&&("http:"===e.protocol||"https:"===e.protocol)&&""!==e.hostname&&""!==e.pathname}(p)?r.Uri.parse(p,!0):""===p&&n?this.getDefaultToolUrl(u,t):void S.resolve("MessageService").showError(`Malformed URL in gitblame.commitUrl. Currently expands to: '${p}'`)}getDefaultToolUrl(t,e){if(t){const n=this.defaultWebPath(t,e.hash,this.isToolUrlPlural(t));if(n)return r.Uri.parse(n,!0)}}gitOriginHostname(t){return e=>{const r=new o.URL(t);if(""===e)return r.hostname;const n=r.hostname.split(".");return void 0!==e&&e in n?n[Number(e)]:"invalid-index"}}updateView(t){t.generated?this.clearView():this.statusBarView.update(t)}clearView(){this.statusBarView.clear()}async getCurrentLineInfo(){const t=S.resolve("ActiveTextEditor").get();if(void 0===t)return z();try{return await this.blame.blameLine(t.document,t.selection.active.line)}catch(t){return z()}}isToolUrlPlural(t){const e=S.resolve("Property");if(!0===e.get("isWebPathPlural"))return!0;const r=e.get("pluralWebPathSubstrings");return void 0!==r&&r.some(e=>t.includes(e))}};var rt;u([(rt=16,(t,e,r)=>{if(void 0===r.value)throw new Error("Invalid trottleFunction usage detected");const n=r.value,o=Symbol();r.value=async function(...t){if(!Z.has(o))return Z.add(o),setTimeout(()=>{Z.delete(o)},rt),n.call(this,t)}}),(t,e,r)=>{if(void 0===r.value)throw new Error("Invalid runNextTick usage detected");const n=r.value;r.value=function(...t){return new Promise(e=>{setImmediate(()=>{e(n.call(this,t))})})}},f("design:type",Function),f("design:paramtypes",[]),f("design:returntype",Promise)],et.prototype,"onTextEditorMove",null),et=u([k(),l(0,x("GitBlame")),l(1,x("StatusBarView")),f("design:paramtypes",[Object,Object])],et);class nt{constructor(t){S.resolve("ErrorHandler").logInfo(`Will not try to blame file "${t}" as it is outside of the current workspace`)}registerDisposeFunction(){}blame(){return Promise.resolve({commits:{},lines:{}})}dispose(){}}class ot{constructor(t){this.terminate=!1,this.fileName=t,this.fileSystemWatcher=this.setupWatcher()}registerDisposeFunction(t){this.clearFromCache=t}async blame(){return S.resolve("StatusBarView").startProgress(),void 0===this.blameInfoPromise&&(this.blameInfoPromise=this.findBlameInfo()),this.blameInfoPromise}dispose(){this.terminate=!0,this.clearFromCache&&(this.clearFromCache(),this.clearFromCache=void 0),this.fileSystemWatcher.close()}setupWatcher(){return s.watch(this.fileName,t=>{"rename"===t?this.dispose():"change"===t&&this.changed()})}changed(){this.blameInfoPromise=void 0}async findBlameInfo(){S.resolve("StatusBarView").startProgress();const{commits:t,lines:e}={commits:{},lines:{}},r=S.resolve("GitBlameStream");try{const n=r.blame(this.fileName);let o=!1;for(;!o;){const{done:r,value:i}=await n.next(this.terminate);r||void 0===i?o=!0:"commit"===i.type?t[i.hash]=i.info:e[i.line]=i.hash}}catch(t){return S.resolve("ErrorHandler").logError(t),{commits:{},lines:{}}}if(this.terminate)return{commits:{},lines:{}};const n=Object.keys(t).length;return S.resolve("ErrorHandler").logInfo(`Blamed file "${this.fileName}" and found ${n} commits`),{commits:t,lines:e}}}class it{async create(t){const e=this.inWorkspace(t.fileName),r=!!e&&this.exists(t.fileName),n=!!e&&this.inGitWorktree(t.fileName);return(await Promise.all([r,n])).every(t=>!0===t)?new ot(t.fileName):new nt(t.fileName)}inWorkspace(t){const e=r.Uri.file(t);return S.resolve("Workspace").in(e)}exists(t){return new Promise(e=>{s.access(t,t=>{e(!t)})})}async inGitWorktree(t){return""!==await async function(t){const e=await Q();try{const r=await X(e,["rev-parse","--show-toplevel"],i.dirname(t));return""===r.trim()?"":i.normalize(r.trim())}catch(t){return S.resolve("ErrorHandler").logError(t),""}}(t)}}function st(t,e=" "){if(1!==e.length)throw new Error(`Invalid split character argument "${e}"`);const r=t.indexOf(e);if(-1===r)return[t,""];return[t.substr(0,r),t.substr(r+1).trim()]}class at{constructor(){this.emittedCommits=new Set}async*blame(t){if(this.process=await async function(t){const e=[];e.push("blame"),S.resolve("Property").get("ignoreWhitespace")&&e.push("-w"),e.push("--incremental"),e.push("--"),e.push(t);const r=await Q(),o={cwd:i.dirname(t)};return S.resolve("ErrorHandler").logCommand(`${r} ${e.join(" ")}`),n.spawn(r,e,o)}(t),null===this.process.stdout||null===this.process.stderr)throw new Error("Unable to setup stdout and/or stderr for git blame process");for await(const t of this.process.stdout){if(yield*this.processChunk(String(t)))return this.terminate()}for await(const t of this.process.stderr)throw new Error(t)}terminate(){this.dispose()}dispose(){this.process&&this.process.kill("SIGTERM")}*processChunk(t){let e=!1;const r=t.split("\n");let n=z();for(const[t,o]of r.entries())if("boundary"!==o){const[i,s]=st(o);if(this.newCommit(i,r[t+1],n)){const t=yield*this.commitDeduplicator(n);n=z(!0),e=e||t}const a=yield*this.processLine(i,s,n);e=e||a}const o=yield*this.commitDeduplicator(n);return e||o}*processLine(t,e,r){if("summary"===t)r.summary=e;else{if(this.isHash(t)){r.hash=t;const[,n,o]=e.split(" ").map(Number);return yield*this.lineGroupToIndividualLines(t,o,n)}this.processAuthorLine(t,e,r)}return!1}processAuthorLine(t,e,r){const[n,o]=st(t,"-");"author"===n?this.fillOwner(r.author,o,e):"committer"===n&&this.fillOwner(r.committer,o,e)}*lineGroupToIndividualLines(t,e,r){let n=!1;for(let o=0;o<e;o++){const e=yield{type:"line",line:r+o,hash:t};n=n||e}return n}*commitDeduplicator(t){return!1===this.emittedCommits.has(t.hash)&&(this.emittedCommits.add(t.hash),yield{type:"commit",info:t,hash:t.hash})}newCommit(t,e,r){return this.isHash(t)&&void 0!==e&&(e.startsWith("author")||e.startsWith("committer"))&&""!==r.hash}isHash(t){return/^[a-z0-9]{40}$/.test(t)}fillOwner(t,e,r){"time"===e?t.timestamp=parseInt(r,10):"tz"===e||"mail"===e?t[e]=r:""===e&&(t.name=r)}}function ct(){const t=t=>({useClass:t}),e={lifecycle:c.Singleton};S.register("ActiveTextEditor",t(I)),S.register("Clipboard",t(M)),S.register("Command",t(P)),S.register("EditorEvents",t(O)),S.register("ExtensionGetter",t(A)),S.register("Workspace",t(R)),S.register("ActionableMessageItem",t(j)),S.register("ErrorHandler",t($),e),S.register("Executor",t(F)),S.register("Property",t(L)),S.register("MessageService",t(D)),S.register("OutputChannelFactory",t(B)),S.register("StatusBarItemFactory",t(N)),S.register("StatusBarView",t(q),e),S.register("GitBlame",t(Y)),S.register("GitExtension",t(et),e),S.register("GitFileFactory",t(it)),S.register("GitBlameStream",t(at))}ct(),exports.activate=function(t){if(S.resolve("Workspace").has()){const e=S.resolve("ErrorHandler"),n=S.resolve("GitExtension"),o=r.commands.registerCommand("gitblame.quickInfo",()=>{n.showMessage()}),i=r.commands.registerCommand("gitblame.online",()=>{n.blameLink()}),s=r.commands.registerCommand("gitblame.addCommitHashToClipboard",()=>{n.copyHash()}),a=r.commands.registerCommand("gitblame.addToolUrlToClipboard",()=>{n.copyToolUrl()});t.subscriptions.push(e,n,o,i,s,a)}},exports.registerContainer=ct;
//# sourceMappingURL=index.js.map
